<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title>Angular 中 RXJS 的应用 - Ten's Blog</title><meta name=Description content="This is my blog"><meta property="og:title" content="Angular 中 RXJS 的应用">
<meta property="og:description" content="跟随 Acme Product Management 工程来理解 RxJS 在 Angular 中的响应式编程。 初步接触 Reactive 在 Angular 的使用中，我们常常使用编程式模式（procedural pattern）实现从后端服务">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-04-08T18:03:02+08:00">
<meta property="article:modified_time" content="2021-04-08T18:03:02+08:00"><meta property="og:site_name" content="My cool site">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Angular 中 RXJS 的应用">
<meta name=twitter:description content="跟随 Acme Product Management 工程来理解 RxJS 在 Angular 中的响应式编程。 初步接触 Reactive 在 Angular 的使用中，我们常常使用编程式模式（procedural pattern）实现从后端服务">
<meta name=application-name content="Ten's Blog">
<meta name=apple-mobile-web-app-title content="Ten's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/><link rel=prev href=https://blog.okten.cn/posts/ng-fundamentals-%E5%9F%BA%E7%A1%80%E5%86%85%E5%AE%B9%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F/><link rel=next href=https://blog.okten.cn/posts/typescript/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Angular 中 RXJS 的应用","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.okten.cn\/posts\/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8\/"},"genre":"posts","keywords":"Angular, RxJS","wordcount":3643,"url":"https:\/\/blog.okten.cn\/posts\/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8\/","datePublished":"2021-04-08T18:03:02+08:00","dateModified":"2021-04-08T18:03:02+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Ten Li"},"description":""}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4005185440822195" crossorigin=anonymous></script>
</head>
<body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Ten's Blog">Ten's Blog</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-thin fa-archive"></i> 所有文章 </a><a class=menu-item href=/tags/><i class="fas fa-thin fa-tag"></i> 标签 </a><a class=menu-item href=/categories/><i class="fas fa-thin fa-folder-open"></i> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Ten's Blog">Ten's Blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts/ title><i class="fas fa-thin fa-archive"></i>所有文章</a><a class=menu-item href=/tags/ title><i class="fas fa-thin fa-tag"></i>标签</a><a class=menu-item href=/categories/ title><i class="fas fa-thin fa-folder-open"></i>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</header><div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div><main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Angular 中 RXJS 的应用</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://blog.okten.cn/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Ten Li</a></span>&nbsp;<span class=post-category>included in <a href=/categories/frontend/><i class="far fa-folder fa-fw" aria-hidden=true></i>Frontend</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-04-08>2021-04-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3643 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static data-kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#初步接触-reactive>初步接触 Reactive</a>
<ul>
<li><a href=#使用-async-pipe>使用 Async Pipe</a></li>
<li><a href=#异常处理>异常处理</a></li>
<li><a href=#onpush-变更检查策略>OnPush 变更检查策略</a></li>
<li><a href=#代码重构>代码重构</a></li>
</ul>
</li>
<li><a href=#构造数据>构造数据</a>
<ul>
<li><a href=#mapping-an-http-response>Mapping an Http Response</a></li>
<li><a href=#改造数组元素>改造数组元素</a></li>
</ul>
</li>
<li><a href=#组合-streams>组合 Streams</a>
<ul>
<li><a href=#将-id-映射为-string>将 Id 映射为 String</a></li>
</ul>
</li>
<li><a href=#活动响应>活动响应</a>
<ul>
<li><a href=#过滤响应>过滤响应</a></li>
<li><a href=#响应异常>响应异常</a></li>
<li><a href=#添加响应>添加响应</a></li>
</ul>
</li>
<li><a href=#最后>最后</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>跟随 Acme Product Management 工程来理解 RxJS 在 Angular 中的响应式编程。</p>
<h2 id=初步接触-reactive>初步接触 Reactive</h2>
<p>在 Angular 的使用中，我们常常使用编程式模式（procedural pattern）实现从后端服务器获取数据，接下来让我们尝试声明式和响应式来实现这个功能。</p>
<h3 id=使用-async-pipe>使用 Async Pipe</h3>
<p>component.ts：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=kr>export</span> <span class=kr>class</span> <span class=nx>ProductListComponent</span> <span class=kr>implements</span> <span class=nx>OnInit</span><span class=p>,</span> <span class=nx>OnDestroy</span> <span class=p>{</span>
  <span class=nx>pageTitle</span> <span class=o>=</span> <span class=s1>&#39;Product List&#39;</span><span class=p>;</span>
  <span class=nx>errorMessage</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>

  <span class=nx>products</span>: <span class=kt>Product</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
  <span class=nx>sub</span>: <span class=kt>Subscription</span><span class=p>;</span>

  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>productService</span>: <span class=kt>ProductService</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>

  <span class=nx>ngOnInit</span><span class=p>()</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>sub</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>getProducts</span><span class=p>()</span>
      <span class=p>.</span><span class=nx>subscribe</span><span class=p>(</span>
        <span class=nx>products</span> <span class=o>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>products</span> <span class=o>=</span> <span class=nx>products</span><span class=p>,</span>
        <span class=nx>error</span> <span class=o>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>errorMessage</span> <span class=o>=</span> <span class=nx>error</span>
      <span class=p>);</span>
  <span class=p>}</span>

  <span class=nx>ngOnDestroy</span><span class=p>()</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>sub</span><span class=p>.</span><span class=nx>unsubscribe</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>component.html：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html>      <span class=p>&lt;</span><span class=nt>table</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;table mb-0&#34;</span>
             <span class=err>*</span><span class=na>ngIf</span><span class=o>=</span><span class=s>&#34;products&#34;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>thead</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Product<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Code<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Category<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Price<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>In Stock<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>thead</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>tbody</span> <span class=err>*</span><span class=na>ngFor</span><span class=o>=</span><span class=s>&#34;let product of products&#34;</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.productName }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.productCode }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.categoryId }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.price | currency:&#34;USD&#34;:&#34;symbol&#34;:&#34;1.2-2&#34; }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.quantityInStock }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>tbody</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>table</span><span class=p>&gt;</span>
</code></pre></div><p>在不使用 RxJS 的情况下，需要 subscribe 服务中获取的 Observable，在其 emit 数据时，将取得到的数据绑定到变量 products 上，模板跟随变量改变而渲染。</p>
<p>在使用 RxJS 时可以使用 angular 的 async pipe 直接将 Observable 绑定到模板中，变更检测识别到 emit 时，会自动渲染画面。</p>
<p>component.ts：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=kr>export</span> <span class=kr>class</span> <span class=nx>ProductListComponent</span> <span class=kr>implements</span> <span class=nx>OnInit</span><span class=p>,</span> <span class=nx>OnDestroy</span> <span class=p>{</span>
  <span class=nx>pageTitle</span> <span class=o>=</span> <span class=s1>&#39;Product List&#39;</span><span class=p>;</span>
  <span class=nx>errorMessage</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>

  <span class=nx>products$</span>: <span class=kt>Observable</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;</span>

  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>productService</span>: <span class=kt>ProductService</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>

  <span class=nx>ngOnInit</span><span class=p>()</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>products$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>getProducts</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>component.html：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html>      <span class=p>&lt;</span><span class=nt>table</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;table mb-0&#34;</span>
             <span class=err>*</span><span class=na>ngIf</span><span class=o>=</span><span class=s>&#34;products$ | async as products&#34;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>thead</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Product<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Code<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Category<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Price<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>In Stock<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>thead</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>tbody</span> <span class=err>*</span><span class=na>ngFor</span><span class=o>=</span><span class=s>&#34;let product of products&#34;</span><span class=p>&gt;</span>
          <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.productName }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.productCode }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.categoryId }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.price | currency:&#34;USD&#34;:&#34;symbol&#34;:&#34;1.2-2&#34; }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
            <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>{{ product.quantityInStock }}<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
          <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>tbody</span><span class=p>&gt;</span>
      <span class=p>&lt;/</span><span class=nt>table</span><span class=p>&gt;</span>
</code></pre></div><p>使用 async pipe 的优点有如下几点：</p>
<ul>
<li>Observable 会在组件初始化时被 subscribe。</li>
<li>返回每次被 emit 的值。</li>
<li>当一个新的项目被 emit 时，无论任何变更检测策略，Angular 都会感知到变更并作出响应的画面渲染。</li>
<li>当组件销毁时自动 unsubscribe。</li>
</ul>
<p>这就是为什么上个实例中使用 async pipe 后不在需要 OnDestroy Hook 的原因，我们不再需要手动 unsubscribe。</p>
<p>在未使用 async pipe 时，subscribe 的 callback 中的异常处理直接通过 Observer 的 error 回调来处理，直接在捕获到异常时将异常 message 赋值到一个 errorMessage 变量中，以插值的方式显示在模板中，那使用 RxJS 的异常处理该如何实现呢？</p>
<h3 id=异常处理>异常处理</h3>
<p>在 Observable 发生任何异常时，catchError 可以捕获到异常，使用这个操作符我们可以：</p>
<ul>
<li>捕获异常后重新抛出一个异常。</li>
<li>也可以在异常发生时替换掉异常的 Observable 使操作继续进行。</li>
</ul>
<h4 id=替换异常>替换异常</h4>
<p>service.ts：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>getProducts</span><span class=p>()</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsUrl</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
        <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
          <span class=k>return</span> <span class=k>of</span><span class=p>([{</span> <span class=nx>id</span>: <span class=kt>1</span><span class=p>,</span> <span class=nx>productName</span><span class=o>:</span> <span class=s1>&#39;cart&#39;</span> <span class=p>},</span>
          			 <span class=p>{</span> <span class=nx>id</span>: <span class=kt>2</span><span class=p>,</span> <span class=nx>productName</span><span class=o>:</span> <span class=s1>&#39;hammer&#39;</span> <span class=p>}]);</span>
        <span class=p>})</span>
      <span class=p>);</span>
  <span class=p>}</span>
</code></pre></div><p>如上在获取 product 数据时，如果发生异常可以捕获后返回一组新的数据的 Observable，使get 请求异常时仍然能够获取到一组假数据。</p>
<blockquote>
<p>of 和 from 都能够创建 Observable</p>
<ul>
<li>of 创建的 Observable 会 emit 每一个实参</li>
<li>from 的期待实参是一个数组，它创建的 Observable 会 emit 数组中每一个元素</li>
</ul>
<p><code>of(...apples)</code> 等价于 <code>from(apples)</code></p>
</blockquote>
<h4 id=重新抛出异常>重新抛出异常</h4>
<p>service.ts：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>getProducts</span><span class=p>()</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsUrl</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
        <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
          <span class=k>return</span> <span class=nx>throwError</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
        <span class=p>})</span>
      <span class=p>);</span>
  <span class=p>}</span>
</code></pre></div><p>throwError 实际上也是个创建 Observable 函数，它创建的 Observable 没有任何项目，只 emit 一个异常通知，所以它也是变相的替换异常。</p>
<h4 id=使用-async-pipe-后如何赋值-errormessage>使用 async pipe 后如何赋值 errorMessage</h4>
<p>component.ts</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>    <span class=k>this</span><span class=p>.</span><span class=nx>products$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>getProducts</span><span class=p>()</span>
      <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
        <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
          <span class=k>this</span><span class=p>.</span><span class=nx>errorMessage</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
          <span class=k>return</span> <span class=nx>EMPTY</span><span class=p>;</span>
        <span class=p>})</span>
      <span class=p>);</span>
</code></pre></div><p>在初始化时，将 service 的 products$ 赋值给组件的 products$ 时可以添加 catchError 操作符，这时当捕获异常时，将 service 处理后的异常信息赋值给 errorMessage变量并显示在画面中。</p>
<p>这里返回了 EMPTY，它是空的 Observable，是 RxJS 中的常量。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=kr>import</span> <span class=p>{</span> <span class=nx>EMPTY</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</code></pre></div><h3 id=onpush-变更检查策略>OnPush 变更检查策略</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=kd>@Component</span><span class=p>({</span>
  <span class=nx>templateUrl</span><span class=o>:</span> <span class=s1>&#39;./product-list.component.html&#39;</span><span class=p>,</span>
  <span class=nx>styleUrls</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;./product-list.component.css&#39;</span><span class=p>],</span>
  <span class=nx>changeDetection</span>: <span class=kt>ChangeDetectionStrategy.OnPush</span>
<span class=p>})</span>
</code></pre></div><p>参照<a href=https://2019919.xyz/16164996860696.html target=_blank rel="noopener noreffer">变更检测</a></p>
<p>当改变为 OnPush 变更检查策略时，通过绑定变量的模板就无法跟随变量变更而进行渲染画面。</p>
<p>这时需要为 errorMessage 也创建一个 Observable。这在后面做 reacting to Action 时再进行修改。</p>
<h3 id=代码重构>代码重构</h3>
<p>这里代码是程序式编程实现的，如果使用声明式编程会有怎样的效果呢？</p>
<p>service.ts：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>products$</span>: <span class=kt>Observable</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsUrl</span><span class=p>)</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>handleError</span><span class=p>)</span>
    <span class=p>);</span>
</code></pre></div><p>component.ts</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=kr>export</span> <span class=kr>class</span> <span class=nx>ProductListComponent</span> <span class=p>{</span>
  <span class=nx>pageTitle</span> <span class=o>=</span> <span class=s1>&#39;Product List&#39;</span><span class=p>;</span>
  <span class=nx>errorMessage</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>

  <span class=nx>products$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>products$</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>errorMessage</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
        <span class=k>return</span> <span class=nx>EMPTY</span><span class=p>;</span>
      <span class=p>})</span>
    <span class=p>);</span>

  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>productService</span>: <span class=kt>ProductService</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>

  <span class=nx>onAdd</span><span class=p>()</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Not yet implemented&#39;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nx>onSelected</span><span class=p>(</span><span class=nx>categoryId</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Not yet implemented&#39;</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>我们在 service 中声明 products$ Observable，它是用来获取 products 的数据，并为其添加了异常处理管道。然后，在组件中我们声明可以供模板使用的 products$ 并将其引用指向 service 声明的 products$，同时也再次为组件中的 products$ 添加异常处理管道获取异常信息以供模板显示。</p>
<p>可以看到，我们不但省略了之前的 OnDestroy Hook，现在连 OnInit Hook 也可以省略了，代码也变得清晰。</p>
<h2 id=构造数据>构造数据</h2>
<p>很多时候，从后端服务器获得的数据并不完全是我们想要的，比如下面的我们如果想在获取的数据中，让 Price 上浮 50%。这时候就用到了 map 操作符。</p>
<h3 id=mapping-an-http-response>Mapping an Http Response</h3>
<p>RxJS 的 map 就像 JavaScript 的 Array.prototype.map 方法一样：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>num</span> <span class=p>=&gt;</span> <span class=nx>num</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=c1>// [2,4,6]
</span></code></pre></div><p>首先我们要了解一个 Http Response Observable 会返回什么数据。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsUrl</span><span class=p>)</span>
</code></pre></div><p>通过 Http get 请求会返回一个 Response，也就是说这个 Http Response Observable 只会 emit 一个 item——Response。那么我们直接使用 map 将无法得到 Product：</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=2.png data-srcset="2.png, 2.png 1.5x, 2.png 2x" data-sizes=auto alt=2.png title=2.png><img class=lazyload src=/svg/loading.min.svg data-src=media/16178761821381/16178763228978.jpg data-srcset="media/16178761821381/16178763228978.jpg, media/16178761821381/16178763228978.jpg 1.5x, media/16178761821381/16178763228978.jpg 2x" data-sizes=auto alt=media/16178761821381/16178763228978.jpg title=media/16178761821381/16178763228978.jpg></p>
<p>可以看到 item 是 Product[] 类型，所以 IDE 报错。也就是说我们需要再将 Product 数组通过 Array.prototype.map 方法进行 price 上浮 50%：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>products$</span>: <span class=kt>Observable</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsUrl</span><span class=p>)</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>map</span><span class=p>(</span><span class=nx>products</span> <span class=o>=&gt;</span> <span class=nx>products</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span>
        <span class=nx>product</span> <span class=o>=&gt;</span> <span class=nx>product</span><span class=p>.</span><span class=nx>price</span> <span class=o>*</span> <span class=mf>1.5</span>
      <span class=p>))</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>handleError</span><span class=p>)</span>
    <span class=p>);</span>
</code></pre></div><p>回顾一下 map 方法，它的返回值是回调函数返回值组成的数组，这里的 callback 返回值是 <code>product.price * 1.5</code>，也就是说现在 products$ 的类型是 Observable&lt;number[]>，果然 IDE 也再次报错，那这回我们如何修改呢？</p>
<h3 id=改造数组元素>改造数组元素</h3>
<p>我们需要的是 Array.prototype.map 的 callback 返回 Product，而不是 number，那我们需要将其返回值构造成 Product 类型：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>products$</span>: <span class=kt>Observable</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>Product</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsUrl</span><span class=p>)</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>map</span><span class=p>(</span><span class=nx>products</span> <span class=o>=&gt;</span> <span class=nx>products</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span>
        <span class=nx>product</span> <span class=o>=&gt;</span> <span class=p>({</span>
          <span class=p>...</span><span class=nx>product</span><span class=p>,</span>
          <span class=nx>price</span>: <span class=kt>product.price</span> <span class=o>*</span> <span class=mf>1.5</span><span class=p>,</span>
          <span class=nx>searchKey</span><span class=o>:</span> <span class=p>[</span><span class=nx>product</span><span class=p>.</span><span class=nx>productName</span><span class=p>],</span>
        <span class=p>})</span> <span class=kr>as</span> <span class=nx>Product</span>
      <span class=p>)),</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>handleError</span><span class=p>)</span>
    <span class=p>);</span>
</code></pre></div><p>这里使用了对象字面量的展开操作符 <code>...</code>，将 product 展开到对象字面量中，并重写 price 属性。</p>
<h2 id=组合-streams>组合 Streams</h2>
<p>有时我们需要多个数据集合，并组合它们的 Observable 数据流为同一个数据流。</p>
<p>如下面这个场景的 Category：</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=media/16178761821381/16178762876466.jpg data-srcset="media/16178761821381/16178762876466.jpg, media/16178761821381/16178762876466.jpg 1.5x, media/16178761821381/16178762876466.jpg 2x" data-sizes=auto alt=media/16178761821381/16178762876466.jpg title=media/16178761821381/16178762876466.jpg></p>
<p>我们的 Products 数据流中有 Category 的 Id，但是在画面显示中，我们想要获 Id 所对应的字符串，这时候就需要将 Products 数据流和 Categories 的数据流组合到一起。</p>
<blockquote>
<p>Combining Function：</p>
<ul>
<li>combineLatest</li>
<li>forkJoin</li>
</ul>
<p>Combining Operator：</p>
<ul>
<li>withLatestFrom</li>
</ul>
</blockquote>
<h3 id=将-id-映射为-string>将 Id 映射为 String</h3>
<p>这里使用 Http get Request 获取 Categorise 数据：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=kr>public</span> <span class=nx>productCategories$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>ProductCategory</span><span class=err>[]</span><span class=p>&gt;(</span><span class=k>this</span><span class=p>.</span><span class=nx>productCategoriesUrl</span><span class=p>);</span>
</code></pre></div><p>可以看出用上面三种组合方式都会得到同样的结果：</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=media/16178761821381/16178763640436.jpg data-srcset="media/16178761821381/16178763640436.jpg, media/16178761821381/16178763640436.jpg 1.5x, media/16178761821381/16178763640436.jpg 2x" data-sizes=auto alt=media/16178761821381/16178763640436.jpg title=media/16178761821381/16178763640436.jpg></p>
<p>使用 combineLatest 方法组合两个 Observable：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>productsWithCategory$</span> <span class=o>=</span> <span class=nx>combineLatest</span><span class=p>([</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>products$</span><span class=p>,</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>productCategoryService</span><span class=p>.</span><span class=nx>productCategories$</span>
  <span class=p>]).</span><span class=nx>pipe</span><span class=p>(</span>
    <span class=nx>map</span><span class=p>(([</span><span class=nx>products</span><span class=p>,</span> <span class=nx>categories</span><span class=p>])</span> <span class=o>=&gt;</span> <span class=nx>products</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span>
      <span class=nx>product</span> <span class=o>=&gt;</span> <span class=p>({</span>
        <span class=p>...</span><span class=nx>product</span><span class=p>,</span>
        <span class=nx>price</span>: <span class=kt>product.price</span> <span class=o>*</span> <span class=mf>1.5</span><span class=p>,</span>
        <span class=nx>category</span>: <span class=kt>categories.find</span><span class=p>(</span><span class=nx>c</span> <span class=o>=&gt;</span> <span class=nx>product</span><span class=p>.</span><span class=nx>categoryId</span> <span class=o>===</span> <span class=nx>c</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>name</span><span class=p>,</span>
        <span class=nx>searchKey</span><span class=o>:</span> <span class=p>[</span><span class=nx>product</span><span class=p>.</span><span class=nx>productName</span><span class=p>],</span>
      <span class=p>})</span> <span class=kr>as</span> <span class=nx>Product</span>
    <span class=p>))</span>
  <span class=p>)</span>
</code></pre></div><p>这里 <code>map(([products, categories]) => {})</code> 使用了解构的新特性，直接用数组 [products, categories] 映射了接收到的结果。</p>
<h2 id=活动响应>活动响应</h2>
<p>应用程序会有很多用户活动响应，比如用户点击按钮，选择标签等。在这个 APM 实例中，如果想要在列表中进行过滤，那就需要我们的列表数据流响应用户的下拉列表框的选择行为，接下来学习 RxJS 的活动响应。</p>
<h3 id=过滤响应>过滤响应</h3>
<pre><code>⁃	#### 为 products 添加 filter
</code></pre>
<p>根据前面的 RxJS 的 map 操作符嵌套 Array.prototype.map，这次使用 Array.prototype.filter 来做 products 的数据过滤代码如下：</p>
<p>component.ts:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=nx>productsSimpleFilter$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>productsWithCategory$</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>map</span><span class=p>(</span><span class=nx>products</span> <span class=o>=&gt;</span> <span class=nx>products</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>product</span> <span class=o>=&gt;</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>selectedCategoryId</span> <span class=o>?</span> <span class=nx>product</span><span class=p>.</span><span class=nx>categoryId</span> <span class=o>===</span> <span class=k>this</span><span class=p>.</span><span class=nx>selectedCategoryId</span> : <span class=kt>true</span>
      <span class=p>))</span>
    <span class=p>)</span>

  <span class=kr>private</span> <span class=nx>selectedCategoryId</span>: <span class=kt>number</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</code></pre></div><p>定义 selectedCategoryId 变量用来获取画面用户 action 值，并通过 filter 过滤结果，这里使用三元运算符来防止 selectedCategoryId 为空，当其为 null 或 undefined 时不添加过滤。</p>
<p>在模板中绑定 productsSimpleFilter$ 后，果然画面上能够过滤掉 categoryId 不等于 1 的数据。</p>
<h4 id=绑定-categories-数据>绑定 Categories 数据</h4>
<p>根据上面所学绑定 Category select 标签的 option。</p>
<p>component.ts：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=nx>categories$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productCategoryService</span><span class=p>.</span><span class=nx>productCategories$</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>errorMessage</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
        <span class=k>return</span> <span class=nx>EMPTY</span><span class=p>;</span>
      <span class=p>})</span>
    <span class=p>);</span>
<span class=p>...</span>
  <span class=nx>onSelected</span><span class=p>(</span><span class=nx>categoryId</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>selectedCategoryId</span> <span class=o>=</span> <span class=o>+</span><span class=nx>categoryId</span><span class=p>;</span>
  <span class=p>}</span>

</code></pre></div><p>component.html：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>select</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-control&#34;</span>
        <span class=err>(</span><span class=na>change</span><span class=err>)=&#34;</span><span class=na>onSelected</span><span class=err>($</span><span class=na>event</span><span class=err>.</span><span class=na>target</span><span class=err>.</span><span class=na>value</span><span class=err>)&#34;</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;0&#34;</span><span class=p>&gt;</span>- Display All -<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>option</span> <span class=err>*</span><span class=na>ngFor</span><span class=o>=</span><span class=s>&#34;let category of categories$ | async&#34;</span>
        <span class=err>[</span><span class=na>value</span><span class=err>]=&#34;</span><span class=na>category</span><span class=err>.</span><span class=na>id</span><span class=err>&#34;</span><span class=p>&gt;</span>{{ category.name }}<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>select</span><span class=p>&gt;</span>
</code></pre></div><p>为 select 添加 onSelected 事件方法，这里使用 <code>+</code> 号将字符串隐式转换为数字。</p>
<p>但是画面刷新后发现 select 选择不同的 category 时并不能使列表数据变更，那我们该如何通知我们的 stream 来响应用户的活动呢？</p>
<h4 id=data-stream-和-action-stream>Data Stream 和 Action Stream</h4>
<p>以 Http 请求获取数据时，我们得到一个 Response，它只有一个 Item，这时这个 Observable 基本上说已经结束了它的使命，有了数据后我们不再需要它，这种 Stream 我们称为 Data Stream。</p>
<p>在用户使用过程中，一个活动可能频繁触发，我们需要一直订阅这种 Observable，响应每次用户的活动，这种 Stream 我们称为 Action Stream。</p>
<p>combineLatest 的特点是：</p>
<ul>
<li>会等到所有的 Observable 都 emit 一次数据之后才开始 emit 数据。</li>
<li>在收集完一次数据之后，任何一个 Observable emit 数据，都会 emit 数据，并不会再次等待所有 Observable 再次 emit 数据。</li>
</ul>
<p>弹珠图如下：</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=media/16178761821381/16178764373479.jpg data-srcset="media/16178761821381/16178764373479.jpg, media/16178761821381/16178764373479.jpg 1.5x, media/16178761821381/16178764373479.jpg 2x" data-sizes=auto alt=media/16178761821381/16178764373479.jpg title=media/16178761821381/16178764373479.jpg></p>
<p>这样就能同时封装 Data Stream 和 Action Stream。</p>
<p>创建 Action Stream 有以下三种方式：</p>
<ol>
<li>使用内置 stream，例如 form 表单的 value changes。</li>
<li>fromEvent</li>
<li>Subject/BehaviorSubject</li>
</ol>
<p>第三种是最常用的方式。</p>
<h4 id=subject-和-behaviorsubject>Subject 和 BehaviorSubject</h4>
<p>Subject 是的特殊 Observable，也是一个 Observer ，它可以多播。</p>
<p>BehaviorSubject 是特殊的 Subject，它在构造时必须有初始值。</p>
<p>接下来我们用 combineLatest 组合 Data Stream 和 Subject 创建的 Action Stream。</p>
<p>component.ts</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>private</span> <span class=nx>categorySelectedSubject</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Subject</span><span class=p>&lt;</span><span class=nt>number</span><span class=p>&gt;();</span>
  <span class=nx>categorySelectedAction$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>categorySelectedSubject</span><span class=p>.</span><span class=nx>asObservable</span><span class=p>();</span>

  <span class=nx>products$</span> <span class=o>=</span> <span class=nx>combineLatest</span><span class=p>([</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>productsWithCategory$</span><span class=p>,</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>categorySelectedAction$</span>
  <span class=p>])</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>map</span><span class=p>(([</span><span class=nx>products</span><span class=p>,</span> <span class=nx>selectedCategoryId</span><span class=p>])</span> <span class=o>=&gt;</span> <span class=nx>products</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>product</span> <span class=o>=&gt;</span>
        <span class=nx>selectedCategoryId</span> <span class=o>?</span> <span class=nx>product</span><span class=p>.</span><span class=nx>categoryId</span> <span class=o>===</span> <span class=nx>selectedCategoryId</span> : <span class=kt>true</span>
      <span class=p>)),</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>errorMessage</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
        <span class=k>return</span> <span class=nx>EMPTY</span><span class=p>;</span>
      <span class=p>})</span>
    <span class=p>);</span>

  <span class=nx>onSelected</span><span class=p>(</span><span class=nx>categoryId</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>categorySelectedSubject</span><span class=p>.</span><span class=nx>next</span><span class=p>(</span><span class=o>+</span><span class=nx>categoryId</span><span class=p>);</span>
  <span class=p>}</span>
</code></pre></div><p>绑定 Data Stream 和 Action Stream 的三部：</p>
<ol>
<li>创建可播的 Observable。</li>
<li>组合 Data Stream 和 Action Stream。</li>
<li>触发 Action 的 next 方法。</li>
</ol>
<p>刷新画面已经可以看到在 select 标签选择不同的 category 时，列表中的数据已经能够过滤，但是画面初始化时没有数据。</p>
<p>回顾下 combineLatest 的弹珠图，必须每个 Observable 都 emit 时，组合后 Stream 才会 emit 项目，而我们没有选择 option 时，Action Stream 并没有 emit 任何项目，所以我们不会接收到数据。接下来学习如何设置初始值。</p>
<h4 id=设置初始值>设置初始值</h4>
<p>startWith 操作符，可以直接为 Action Stream 添加 startWith 操作的管道：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=k>this</span><span class=p>.</span><span class=nx>categorySelectedAction$</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>startWith</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</code></pre></div><p>果然这回画面初始化时就能显示所有的 products 了。</p>
<p>BehaviorSubject 是有初始值的 Subject，这里同样也可以使用 BehaviorSubject 来实现：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>private</span> <span class=nx>categorySelectedSubject</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BehaviorSubject</span><span class=p>&lt;</span><span class=nt>number</span><span class=p>&gt;(</span><span class=mi>0</span><span class=p>);</span>
  <span class=nx>categorySelectedAction$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>categorySelectedSubject</span><span class=p>.</span><span class=nx>asObservable</span><span class=p>();</span>
</code></pre></div><p>刷新画面，同样也成功修复此功能。</p>
<h3 id=响应异常>响应异常</h3>
<p>前面将变更检测策略改为了 OnPush，导致我们绑定的变量已经不能被检测器所检测，那么就需要将变量编程一个 Observable。</p>
<p>我们的 errorMessage 不会像 Data Stream 一样只使用一次，而是一个会频繁发生的 Action Stream，所以这里选择使用 Subject 来实现。</p>
<p>component.ts</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>private</span> <span class=nx>errorMessageSubject</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Subject</span><span class=p>();</span>
  <span class=kr>public</span> <span class=nx>errorMessageAction$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>errorMessageSubject</span><span class=p>.</span><span class=nx>asObservable</span><span class=p>();</span>

  <span class=kr>public</span> <span class=nx>products$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>productService</span><span class=p>.</span><span class=nx>productsWithCategory$</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>catchError</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>errorMessageSubject</span><span class=p>.</span><span class=nx>next</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
        <span class=k>return</span> <span class=nx>EMPTY</span><span class=p>;</span>
      <span class=p>})</span>
    <span class=p>);</span>
</code></pre></div><p>component.html</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;alert alert-danger&#34;</span>
     <span class=err>*</span><span class=na>ngIf</span><span class=o>=</span><span class=s>&#34;errorMessageAction$ | async as errorMessage&#34;</span><span class=p>&gt;</span>
  <span class=p>{{</span><span class=nx>errorMessage</span><span class=p>}}</span>
<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</code></pre></div><h3 id=添加响应>添加响应</h3>
<p>应用 merge 组合函数和 scan 操作符。
merge 将 products 的 Data Stream 和添加操作的 Action Stream 连成一串，emit 的第一个项目是取回的全部数据，emit 的第二个项目是添加的新 product 数据。通过 scan 操作符将第二个项目添加到第一个项目中并输出。</p>
<p>service.ts</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript>  <span class=kr>public</span> <span class=nx>productsWithAdd$</span> <span class=o>=</span> <span class=nx>merge</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>productsWithCategory$</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>productInsertedAction$</span><span class=p>)</span>
    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
      <span class=nx>scan</span><span class=p>((</span><span class=nx>products</span>: <span class=kt>Product</span><span class=p>[],</span> <span class=nx>insertedProduct</span>: <span class=kt>Product</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>[...</span><span class=nx>products</span><span class=p>,</span> <span class=nx>insertedProduct</span><span class=p>])</span>
    <span class=p>)</span>
</code></pre></div><p>这里使用了数组的展开操作符 <code>...</code> 将 products 拷贝到新的数组中。</p>
<h2 id=最后>最后</h2>
<p><a href=https://github.com/ten-ltw/Angular-RXJS target=_blank rel="noopener noreffer">代码</a></p>
<p><a href=https://github.com/WangYuLue/simple-rxjs target=_blank rel="noopener noreffer">RxJS模拟实现</a></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2021-04-08</span>
</div></div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/ data-title="Angular 中 RXJS 的应用" data-hashtags=Angular,RxJS><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/ data-hashtag=Angular><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/ data-title="Angular 中 RXJS 的应用"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/ data-title="Angular 中 RXJS 的应用"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.okten.cn/posts/angular-%E4%B8%AD-rxjs-%E7%9A%84%E5%BA%94%E7%94%A8/ data-title="Angular 中 RXJS 的应用"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/angular/>Angular</a>,&nbsp;<a href=/tags/rxjs/>RxJS</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/ng-fundamentals-%E5%9F%BA%E7%A1%80%E5%86%85%E5%AE%B9%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F/ class=prev rel=prev title="ng-fundamentals 基础内容查缺补漏"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>ng-fundamentals 基础内容查缺补漏</a>
<a href=/posts/typescript/ class=next rel=next title="TypeScript 补漏">TypeScript 补漏<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div>
</div>
</article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2020 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.okten.cn/ target=_blank>Ten Li</a></span>&nbsp;|&nbsp;<span class=license><a rel=‘license external nofollow noopener noreffer’ href=‘https://creativecommons.org/licenses/by-nc/4.0/’ target=‘_blank’>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw" aria-hidden=true></i>
</a>
</div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{algoliaAppID:"OOS30TQZ13",algoliaIndex:"my_blog",algoliaSearchKey:"fe316b1e710c67a296e3ca697159b8f7",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-SHZBTMBMCF',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-SHZBTMBMCF" async></script></body>
</html>